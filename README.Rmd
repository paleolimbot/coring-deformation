---
title: "Modelling deformation and horizontal sectioning of lake sediments"
author: |-
  Dewey Dunnington (1), Ian Spooner (1)
  (1) Department of Earth & Environmental Science, Acadia University, 12 University Ave. Wolfville, Nova Scotia, Canada B4P 2R5
csl: journal-of-paleolimnology.csl
output:
  html_document:
    fig_caption: yes
    md_extensions: -autolink_bare_uris
    self_contained: no
  md_document:
    variant: markdown_github
  word_document:
    fig_caption: yes
    md_extensions: -autolink_bare_uris
    reference_docx: styles.docx
nocite: |
  @white12, @dunnington15, @menounos05, @menounos08, @spooner97
bibliography: bibliography.bib
---

```{r, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(dpi=150, echo=FALSE, warning=FALSE, message=FALSE)

library(ggplot2)
library(dplyr)
library(multidplyr) # devtools::install_github("hadley/multidplyr")
source("R/deformation_library.R") # functions
source("data-raw/collect_layers.R") # layers data
source("R/layer_plot.R") # layer plotting
```

# Abstract

Not yet...

# Introduction

That deformation and compression of lake sediment occurs during coring has long been known [@martin82; @wright93], and designs of new coring devices have strived to minimize the conditions that promote deformation during coring [@martin82; @lane02]. Compression of sediment occurs during coring is a widely accepted phenomenon [@glew01], however convex upwards deformation, while widely observed [@wright93; @rosenbaum10], is infrequently discussed. The idea that horizontal sectioning (extrusion) of deformed sediment is undesirable has been previously noted [@rosenbaum10], however the degree to which this deformation occurs and the effect that deformation has on paleolimnological data derived from horizontal sectioning has never been investigated quantitatively.

Rather than suggest that deformation does not occur or that a particular coring method prevents this from happening, we take the approach that acknowledging deformation and its effect on paleolimnological data is a the most reasonable approach. We suspect, given the innumerable paleolimnological studies that use coring and extrusion to produce reasonable and reproducible results, that either deformation or its effect on the data is minimal. This paper is our attempt to quantify and constrain the degree to which convex upwards deformation adds bias to horizontally sectioned paleolimnological data.

# Methods

We used R statistical software [@r13] to model, manipulate, and visualize our data. Packages *dplyr* and *ggplot2* were used for manipulation and visualization of data, respectively [@wickham_dplyr; @wickham_ggplot].

```{r}
# define parameters
barrel_width <- 6 # use 6 cm for barrel width
slice_sizes <- c(0.1, 0.5, 1)
cellsize <- 0.05
```


## Core photo analysis

To calculate parameters for the deformation model, we loaded `r nrow(deformed_core_photos)` scale photos of deformed cores from `r length(unique(deformed_core_photos))` sources into ImageJ software and digitized deformed strata (Table 1). Coordinates were transformed to `r` and `d` values for individual strata by subtracting the minimum `d` value from the rest of the values, and subtracting the central `x` value from the rest of the values. Power regression (quadratic) was performed on the data to obtain reasonable coefficients for minimum, maximum, and mean levels of deformation.

```{r, results='asis'}
knitr::kable(deformed_core_photos %>% select(photo, nlayers, reference),
             col.names=c("Photo ID", "Layers Digitized", "Reference"),
             caption="Table 1. Sources of core photos that contained digitized layers used in this study.")
```

## Deformation model

We modeled horizontal sections with height *H* and diameter *D* as a 3-dimensional raster grid with a cell size of `r cellsize/10` mm (Figure 1). For each cell *i*, an original depth *d~0i~* was calculated with reasonable minimum, maximum, and mean parameters obtained from digitized strata. Density histograms were then obtained to estimate the contribution of each original depth *d~0~* to the slice. For each slice, *d*=0 refers to the middle of the slice. We produced these models for *D*=`r barrel_width` cm, as this represents the barrel width of our Glew [-@glew89] gravity corer. Compression was not modelled using this method, although modification of this model would make including compression possible.

![Figure 1. Schematic of variables used in the deformation model.](figs/fig2_deformation_vars.png)

## Effect on paleolimnological data

To model the concentration (mass fraction) we would obtain by sectioning and homogenizing a sample with variable concentration and density, we need to calculate total mass of the target substance divided by the mass of the slice. With a 3-dimensional raster grid using *n* cells, this value can be written as a sum of the product of concentration ($w$), density ($\rho$), and volume (*V*) divided by the sum of the product of *V* and $\rho$ (1).

$$w_{avg} = \frac{\sum_{i=1}^{n} w_i\rho_iV_i}{\sum_{i=1}^{n} \rho_iV_i}$$

We can remove *V~i~* from the summation in both the numerator and denominator because the cell size is constant for each *i*, and write $w$ and $\rho$ as functions of *d~0i~*.

$$w_{avg} = \frac{\sum_{i=1}^{n} w(d_{0i})\rho(d_{0i})}{\sum_{i=1}^{n} \rho(d_{0i})}$$

Equation (2) in combination with our deformation model allows for modelling the effect of sectioning, homogenization, and deformation given high-resoution un-altered data. We used fictional generated data to test our deformation model inspired by 1 mm resolution XRF core scanner data [@guyard07; @brunschon10; @kylander11], and a linear dry density gradient from 0.1 to 0.5 g/cm^3^. Generated data was transformed and smoothed random log normal data with a set seed for repeatability purposes.


```{r}
# generate data
original_data <- create_random_data(seed=2500, smoothing=10, func=rlnorm,
                                    transform=function(x) 1.5 ^ x * 10,
                                    density=c(0.1, 0.5),
                                    maxdepth=20, cellsize=cellsize)

# ggplot(original_data, aes(y=d0, x=vals)) + geom_path() + scale_y_reverse()
```


# Results

## Core photo analysis

```{r, fig.cap="Figure 2. Histogram of deformation coefficients from digitized layers."}
ggplot(deformed_layers, aes(a)) + geom_histogram(bins=30)
```

```{r, fig.cap="Figure 3. Representative layers for selected deformation coefficients."}
# plot core photos
op <- par(mfrow=c(2, 3), oma=c(0,0,0,0), mar=c(1,0.1,1,0.1))
plot_layer("crevice_lake.5", title="crevice_lake.5 (a=0.10)") # 0.1
plot_layer("crevice_lake.12", title="crevice_lake.12 (a=0.20)") # 0.2
plot_layer("menounos_cheak2.2", title="menounos_cheak2.2 (a=0.40)") # 0.4

plot_layer("whistler_gc8.1", title="whistler_gc8.1 (a=0.10)") # 0.1
plot_layer("menounos_cheak1.7", title="menounos_cheak1.7 (a=0.19)") # 0.2
plot_layer("suzielake_2.9", title="suzielake_2.9 (a=0.41)") # 0.4
par(op); rm(op)

# these are used in the model later
mina <- round(min(deformed_layers$a), 3)
maxa <- round(max(deformed_layers$a), 2)
meana <- round(mean(deformed_layers$a), 2)
coeffs <- c(0, 0.1, 0.2, 0.4)
```

We digitized `r length(unique(deformed_core_photos$layercode))` deformed layers from `r length(unique(deformed_core_photos$core))` scale photos of split cores. The quadratic regression produced an excellent fit of the data (*r^2^* from `r format(min(deformed_layers$r2), digits=2)` to `r format(max(deformed_layers$r2), digits=2)`). Coefficients for *x^2^* ranged from `r mina` to `r maxa`, with a mean of `r meana`.

## Deformation model

```{r}
# expand to grid
params <- expand.grid(slicesize=slice_sizes, coeff=coeffs)

# define a wrapper function that will create the model based on the
# parameters we would like to vary
deformation_model_wrapper <- function(slicesize, coeff) {
  deformation_model(slicesize, 
                      d0=function(d, r) d - coeff * r^2, 
                      width = barrel_width, 
                      cellsize = cellsize)
}

# create the models in long form so we can plot with facets
all <- params %>% 
  group_by(slicesize, coeff) %>% 
  do(deformation_model_wrapper(.$slicesize, .$coeff))
```

```{r, fig.cap="Figure 4. Distribution of d~0~ for d=0 by deformation coefficient."}
# overhead view (same for all sizes of slice)
ggplot(all %>% filter(abs(z)==min(abs(z)), slicesize==all$slicesize[1]), aes(x=x, y=y)) + 
  geom_raster(aes(fill=d0)) + 
  scale_fill_gradient2() + scale_y_reverse() + 
  coord_fixed() + facet_wrap(~coeff) + labs(x=NULL, y=NULL)
```

```{r, fig.cap="Figure 5. Distribution of d~0~ of a vertical sliced section for multiple deformation coefficients and slice sizes.", fig.height=2}
# side on view
ggplot(all %>% filter(abs(y)==min(abs(y))), aes(x=x, y=z)) + geom_raster(aes(fill=d0)) + 
  scale_fill_gradient2() + scale_y_reverse(breaks=NULL) + 
  coord_fixed() + facet_grid(slicesize ~ coeff) +
  labs(x="Deformation coefficient (a)", y="Extrusion interval (cm)")
```

```{r, fig.cap="Figure 6. Distribution of d~0~ values modelled for multiple deformation coefficients and slice sizes."}
# create histograms with binwidth of cellsize, except with the $density param)
create_histogram <- function(vals) {
  limit <- round(max(abs(vals)) / cellsize) * cellsize #snap to cellsize
  breaks <- seq(-limit-cellsize, limit+cellsize, cellsize)
  h <- hist(vals, breaks=breaks, plot=FALSE)
  # fill smoothing model with zeros to make symmetrical
  return(data.frame(d=breaks[-1], density=h$density))
}

histograms <- all %>% 
  group_by(slicesize, coeff) %>% 
  do(create_histogram(.$d0))

# plot (same as density histogram but this is faster)
ggplot(histograms %>% filter(density != 0), aes(x=d, y=density)) + 
  geom_bar(width=cellsize, stat="identity") + 
  facet_grid(slicesize ~ coeff) +
  labs(x="Deformation coefficient (a)", y="Extrusion interval (cm)")
```

## Effect on paleolimnological data

Using the formulas, if we model extrusion, this is the effect on the data:

```{r, message=FALSE, fig.cap="Figure 7. Extrusion and deformation modelled for artificial 0.5 mm resolution concentration data."}
# use multicore to speed this up
cluster <- create_cluster(3)
cluster_assign_value(cluster, "extrude", extrude)
cluster_assign_value(cluster, "original_data", original_data)
sliced <- all %>%
  group_by(slicesize, coeff) %>% 
  partition(slicesize, coeff, cluster=cluster) %>%
  do(extrude(., original_data)) %>%
  collect()

ggplot(sliced, aes(y=d, x=vals)) + geom_path() + scale_y_reverse() + 
  facet_grid(slicesize ~ coeff, scales="free_x") + 
  labs(x="Deformation coefficient (a)", y="Extrusion interval (cm)")
```

# Discussion

Any other literature out there? Haven't yet checked...

# Conclusions

There is a limit to how small extrusion intervals can get based on deformation. For minor deformation, even small extrusion intervals are ok.

# Acknowledgements

Thanks to...

# References
