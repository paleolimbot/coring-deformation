---
title: "Modeling the effect of convex upward deformation and horizontal sectioning on paleolimnological data"
author: |-
  Dewey Dunnington (1), Ian Spooner (1)
  (1) Department of Earth & Environmental Science, Acadia University, 12 University Ave. Wolfville, Nova Scotia, Canada B4P 2R5
csl: journal-of-paleolimnology.csl
output:
  word_document:
    fig_caption: yes
    md_extensions: -autolink_bare_uris
    reference_docx: styles.docx
  md_document:
    variant: markdown_github
  html_document:
    fig_caption: yes
    md_extensions: -autolink_bare_uris
    self_contained: no
nocite: |
  @white12, @dunnington15, @menounos05, @menounos08, @spooner97
bibliography: bibliography.bib
---

```{r, message=FALSE, warning=FALSE, include=FALSE}
# setup libraries and options
knitr::opts_chunk$set(dpi=150, echo=FALSE, warning=FALSE, message=FALSE)

library(ggplot2)
library(dplyr)
library(multidplyr) # devtools::install_github("hadley/multidplyr")
source("R/deformation_library.R") # functions
source("data-raw/collect_layers.R") # layers data
source("R/layer_plot.R") # layer plotting
```


```{r}
# define parameters
barrel_width <- 6.5 # use 6.5 cm for barrel width
slice_sizes <- c(0.1, 0.5, 1)
cellsize <- 0.05

# define parameters used in the model later
mina <- round(min(deformed_layers$a), 3)
maxa <- round(max(deformed_layers$a), 2)
meana <- round(mean(deformed_layers$a), 2)
coeffs <- c(0, 0.1, 0.2, 0.4)
```

```{r}
# generate data
original_data <- create_random_data(seed=2500, smoothing=10, func=rlnorm,
                                    transform=function(x) 1.5 ^ x * 10,
                                    density=c(0.1, 0.5),
                                    maxdepth=20, cellsize=cellsize)

# ggplot(original_data, aes(y=d0, x=vals)) + geom_path() + scale_y_reverse()
```

```{r}
# create models
params <- expand.grid(slicesize=slice_sizes, coeff=coeffs)

# define a wrapper function that will create the model based on the
# parameters we would like to vary
deformation_model_wrapper <- function(slicesize, coeff) {
  deformation_model(slicesize, 
                      d0=function(d, r) d - coeff * r^2, 
                      width = barrel_width, 
                      cellsize = cellsize)
}

# create the models in long form so we can plot with facets
all <- params %>% 
  group_by(slicesize, coeff) %>% 
  do(deformation_model_wrapper(.$slicesize, .$coeff))
```

```{r}
# perform the extrusion
cluster <- create_cluster(7)
cluster_assign_value(cluster, "extrude", extrude)
cluster_assign_value(cluster, "original_data", original_data)
sliced <- all %>%
  group_by(slicesize, coeff) %>% 
  partition(slicesize, coeff, cluster=cluster) %>%
  do(extrude(., original_data)) %>%
  collect()
```

Keywords: Coring, 3D Model, Extrusion, Stratigraphy

# Abstract

We analyzed photos of convex upward deformation in split cores to obtain reasonable parameters with which to model the effect of convex upward deformation on paleolimnological data, and, using a 3-dimensional raster model, modeled the effect of this deformation on paleolimnological data. The data indicated that convex upward deformation integrates sample from an increasingly wider range of stratigraphic layers with increasing degree of deformation. After applying deformation extruded concentration profiles were nearly identical despite varying the extrusion interval between 0.1 cm and 1 cm, suggesting there is a limit to the resolution attainable by horizontal sectioning if deformation occured during sampling. Collectively our data suggest that determining the degree of deformation due to coring is essential prior to conducting high-resolution analysis of horizontally sectioned samples.

# Introduction

Deformation and compression of lake sediment  during coring has long been known [@martin82; @wright93], aand coring equipment design  hasattempted to minimize the conditions that promote deformation during coring [@martin82; @lane02]. Compression of sediment  during coring is a widely accepted phenomenon [@glew01], however convex upward deformation, while widely observed [@wright93; @rosenbaum10], is infrequently discussed. The quality of the data derived from horizontal sectioning (extrusion) of deformed sediment  has been discussed [@rosenbaum10], however the degree to which this deformation occurs and the effect that deformation has on paleolimnological data has not been investigated quantitatively. ADD REFERENCES AND DISCUSSION FROM WORK ON PALEOMAG

We suspect, given the large number of paleolimnological studies that use coring and extrusion to produce reproducible results, that either deformation or its effect on the data is minimal. This paper is our attempt to quantify and constrain the degree to which convex upward deformation adds bias to horizontally sectioned paleolimnological data. 

# Methods

We used R statistical software [@r13] to model, manipulate, and visualize our data. Packages *dplyr* and *ggplot2* were used for manipulation and visualization of data, respectively [@wickham_dplyr; @wickham_ggplot].

## Core photo analysis

To calculate parameters for the deformation model, we loaded `r nrow(deformed_core_photos)` scale photos of deformed cores from `r length(unique(deformed_core_photos$reference))` sources into image analysis software and digitized deformed strata (Table 1). Power regression (quadratic) was performed on the each layer to obtain reasonable coefficients for minimum, maximum, and mean levels of deformation.

From Acton et al. 2002: Z(r)=-b[ln(1-r/R) + r/R]

## Deformation model

We modeled horizontal sections with height *H* and diameter *D* as a 3-dimensional raster grid with a cell size of `r cellsize*10` mm (Fig. 1). For each cell *i*, an original depth (i.e. depth prior to convex upward deformation) *d~0i~* was calculated with reasonable minimum, maximum, and mean parameters obtained from digitized strata. Density histograms were then produced to estimate the contribution of each original depth *d~0~* to the slice. For each slice, *d*=0 refers to the middle of the slice. We produced these models for *D*=`r barrel_width` cm, as this represents the barrel width of our Glew [-@glew89] gravity corer. Compression was not modeled using this method, although modification of this model would make including compression possible.

## Effect on paleolimnological data

To model the concentration (mass fraction) we would obtain by sectioning and homogenizing a sample with variable concentration and density, we need to calculate total mass of the target substance divided by the mass of the slice. With a 3-dimensional raster grid using *n* cells, this value can be written as a sum of the product of concentration ($w$), density ($\rho$), and volume (*V*) divided by the sum of the product of *V* and $\rho$ (1).

$$w_{avg} = \frac{\sum_{i=1}^{n} w_i\rho_iV_i}{\sum_{i=1}^{n} \rho_iV_i}$$

We can remove *V~i~* from the summation in both the numerator and denominator because the cell size is constant for each *i*, and write $w$ and $\rho$ as functions of *d~0i~*.

$$w_{avg} = \frac{\sum_{i=1}^{n} w(d_{0i})\rho(d_{0i})}{\sum_{i=1}^{n} \rho(d_{0i})}$$

Equation (2) in combination with our deformation model allows for modeling the effect of sectioning, homogenization, and deformation given high-resolution un-altered data. We used fictional generated data to test our deformation model inspired by 1 mm resolution XRF core scanner data [@guyard07; @brunschon10; @kylander11], and a linear dry density gradient from 0.1 to 0.5 g/cm^3^. Generated data was transformed and smoothed random log normal data with a set seed for replicability purposes.

# Results

## Core photo analysis

We digitized `r nrow(deformed_layers)` deformed layers from `r nrow(deformed_core_photos)` scale photos of split cores. The quadratic regression was able to model the data well (*r^2^* from `r format(min(deformed_layers$r2), digits=2)` to `r format(max(deformed_layers$r2), digits=2)`). Coefficients for *x^2^* in the quadratic regression ranged from `r round(min(deformed_layers$a), 3)` to `r round(max(deformed_layers$a), 2)`, with a mean of `r round(mean(deformed_layers$a), 2)` (Fig. 2). We chose 0, 0.1, 0.2, and 0.4 as coefficients for our model to produce a reasonable summary of the deformation that was observed (Fig. 3).

## Deformation model

Slices of size 0.1 cm, 0.5 cm, and 1 cm were modeled with a core barrel diameter of 6.5 cm. When *d*=0, *d~0~* values ranged from 0 cm to -4 cm and were more negative with increasing deformation (Fig. 4; Fig. 5). Slices represented a wider range of *d~0~* values with increasing deformation (Fig. 5; Fig. 6), and when deformation was >0.2, slice sizes smaller than 1 cm did not result in decreasing the range of *d~0~* values.

## Effect on paleolimnological data

As expected, increasing the thickness of the extrusion interval decreased the detail that was visible in the data (Fig. 7). The original data include thin (<0.5 cm) layers of high concentration (>60 units), only some of which were resolvable at extrusion intervals greater than 1 mm. Peak values were lower with increasing extrusion interval size, reflecting the inclusion of less concentrated material within the interval. High values in the topmost sample are an artifact of the model; it is likely that the behavior of deformation differs at the top of the core compared to deformation below. Increasing the degree of deformation also decreased the ability to resolve high concentration layers, the peak concentration  and also resulted in  increasing the depth at which peak values were observed. When deformation occurred, decreasing the extrusion interval size did not result in increasing the effective resolution of the data. In particular, the extrusion interval of 0.1 cm and 0.5 cm produced nearly identical results when any deformation was applied in our model.

# Conclusions

The data indicated that even minimal deformation has an effect on paleolimnological data. Many deformed core photos that were analyzed were of cores collected by percussion coring, which is known to produce intense convex upward deformation [@reasoner93], however some photos of split gravity cores also contained a small degree of deformation. Even when a small degree of deformation occurred, decreasing the extrusion interval did not result in an appreciably different paleolimnological data (Fig. 7) or in decreasing the range of depths represented by the slice (Fig. 6). Extrusion methods can produce sediment intervals of less than 0.1 cm [@cocquyt04], however our data suggest that reducing the extrusion interval  does not increase the effective resolution of the data if sediment has been deformed by coring. Our data suggest that checking for deformation due to coring is essential prior to conducting high-resolution analysis of horizontally sectioned samples.

# Acknowledgements

We acknowledge funding from the Natural Sciences and Engineering Research Council (NSERC) of Canada and the comments on this manuscript from the Department of Earth & Environmental Science at Acadia University.

# Tables

```{r, results='asis'}
# Table 1
knitr::kable(deformed_core_photos %>% select(photo, nlayers, reference),
             col.names=c("Photo ID", "Layers Digitized", "Reference"),
             caption="Table 1. Sources of core photos that contained digitized layers used in this study.")
```

# Figures

![*Fig. 1* Schematic of variables used in the deformation model. Models were produced for sections of diameter *D* and thickness *H*. Each point *i* in the section had a coordinate *d~i~* and *r~i~*, which were used to calculate the depth prior to convex upward deformation (*d~0i~*)](figs/fig2_deformation_vars.png)

```{r, fig.cap="*Fig. 2* Histogram of deformation coefficients (a) from digitized layers. Higher deformation coefficients corresponded to strata that were more deformed; lower deformation coefficients corresponded to strata that were less deforemed."}
ggplot(deformed_layers, aes(a)) + geom_histogram(bins=30) + labs(x="Deformation coefficient (a)", y="Count")
```

```{r, fig.cap="*Fig. 3* Representative layers for selected deformation coefficients."}
# plot core photos
op <- par(mfrow=c(2, 3), oma=c(0,0,0,0), mar=c(1,0.1,1,0.1))
plot_layer("crevice_lake.5", title="crevice_lake.5 (a=0.10)", htin=0.07) # 0.1
plot_layer("crevice_lake.12", title="crevice_lake.12 (a=0.20)", htin=0.07) # 0.2
plot_layer("cheak2.2", title="cheak2.2 (a=0.40)", htin=0.07) # 0.4

plot_layer("whistler_gc8.1", title="whistler_gc8.1 (a=0.10)", htin=0.07) # 0.1
plot_layer("cheak1.7", title="cheak1.7 (a=0.19)", htin=0.07) # 0.2
plot_layer("suzielake_2.9", title="suzielake_2.9 (a=0.41)", htin=0.07) # 0.4
par(op); rm(op)
```

```{r, fig.cap="*Fig. 4* Distribution of d~0~ for d=0 by deformation coefficient. Value a=0 indicates no deformation; a=.4 indicates maximum deformation in model. Coordinates are in cetimeters."}
# overhead view (same for all sizes of slice)
ggplot(all %>% filter(abs(z)==min(abs(z)), slicesize==all$slicesize[1]), aes(x=x, y=y)) + 
  geom_raster(aes(fill=d0)) + 
  scale_fill_gradient2(name=expression(d[0])) + scale_y_reverse() + 
  coord_fixed() + 
  facet_wrap(~coeff, labeller = labeller(coeff=function(a) paste0("a=", a))) + 
  labs(x=NULL, y=NULL)
```

```{r, fig.cap="*Fig. 5* Distribution of d~0~ of a vertical sliced section for multiple deformation coefficients and slice sizes. Coordinates are in centimeters.", fig.height=2}
# side on view
ggplot(all %>% filter(abs(y)==min(abs(y))), aes(x=x, y=z)) + geom_raster(aes(fill=d0)) + 
  scale_fill_gradient2(name=expression(d[0])) + scale_y_reverse(breaks=NULL) + coord_fixed() + 
  facet_grid(slicesize ~ coeff, labeller = labeller(coeff=function(a) paste0("a=", a))) +
  labs(x=NULL, y=NULL)
```

```{r, fig.cap="*Fig. 6* Distribution of d~0~ values modeled for multiple deformation coefficients and slice sizes. Wide distributions indicate that a wide range of original depths (d~0~) contributed to that slice. Negative d~0~ values in the distribution indicate the inclusion of strata from above the center depth of the slice."}
# create histograms with binwidth of cellsize, except with the $density param)
create_histogram <- function(vals) {
  limit <- round(max(abs(vals)) / cellsize) * cellsize #snap to cellsize
  breaks <- seq(-limit-cellsize, limit+cellsize, cellsize)
  h <- hist(vals, breaks=breaks, plot=FALSE)
  # fill smoothing model with zeros to make symmetrical
  return(data.frame(d=breaks[-1], density=h$density))
}

histograms <- all %>% 
  group_by(slicesize, coeff) %>% 
  do(create_histogram(.$d0))

# plot (same as density histogram but this is faster)
ggplot(histograms %>% filter(density != 0), aes(x=d, y=density)) + 
  geom_bar(width=cellsize, stat="identity") + 
  facet_grid(slicesize ~ coeff, labeller = labeller(coeff=function(a) paste0("a=", a), slicesize=function(H) paste0("H=", H))) +
  labs(x=expression(d[0]~('cm')), y="Density")
```


```{r, fig.cap="*Fig. 7* Extrusion and deformation modeled for artificial 0.5 mm resolution concentration data."}
ggplot(sliced, aes(y=d, x=vals)) + geom_path() + scale_y_reverse() + 
  facet_grid(slicesize ~ coeff, 
             scales="free_x", 
             labeller = labeller(coeff=function(a) paste0("a=", a), slicesize=function(H) paste0("H=", H))) +
  labs(x="Value (arbitrary units)", y="Depth (cm)")
```

# References
